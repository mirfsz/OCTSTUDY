{% extends "base.html" %}

{% block title %}MCQ Drill - GRFan{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Back to Dashboard Button -->
    <div class="mb-4">
        <a href="{{ url_for('index') }}" class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">MCQ Drill</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Test your knowledge with quick practice questions</p>
    </div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <div class="text-sm text-blue-800 dark:text-blue-200">
                <span class="font-semibold">‚å®Ô∏è Keyboard Shortcuts:</span> Press <kbd class="px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs font-mono">1-4</kbd> to select answers, <kbd class="px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs font-mono">Enter</kbd> to submit/next
            </div>
        </div>
    </div>

    {% if questions %}
    <!-- Progress Bar -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progress</span>
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300"><span id="progressCount">0</span>/{{ questions|length }}</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <span class="text-sm text-gray-500 dark:text-gray-400">
                    Question <span id="currentQuestion">1</span> of {{ questions|length }}
                </span>
                <div class="text-right">
                    <div id="scoreDisplay" class="text-sm font-medium">
                        <span class="text-green-600 dark:text-green-400">‚úì <span id="correctDisplay">0</span></span>
                        <span class="mx-2 text-gray-400">|</span>
                        <span class="text-red-600 dark:text-red-400">‚úó <span id="wrongDisplay">0</span></span>
                    </div>
                </div>
            </div>

            <div id="questionContainer">
                {% for question in questions %}
                <div class="question-item {% if loop.index != 1 %}hidden{% endif %}" data-question-id="{{ question.id }}" data-question-index="{{ loop.index0 }}" data-correct-answer="{{ question.answer_idx }}">
                    <div class="mb-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            {{ question.topic_name }}
                        </span>
                    </div>
                    
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-6">
                        {{ question.stem }}
                    </h3>

                    <div class="space-y-3 answer-choices">
                        {% for choice in question.choices %}
                        <label class="answer-option flex items-center p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all" data-choice-index="{{ loop.index0 }}">
                            <input type="radio" name="answer_{{ loop.index0 }}" value="{{ loop.index0 }}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 choice-radio">
                            <span class="ml-3 text-gray-900 dark:text-white flex-1">{{ choice }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <!-- Feedback Banner -->
                    <div class="feedback-banner mt-6 p-4 rounded-lg hidden">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="feedback-icon h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="feedback-title text-lg font-medium"></h3>
                                <p class="feedback-message mt-1 text-sm"></p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button class="submit-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors text-lg">
                            Submit Answer
                        </button>
                    </div>

                    <div class="explanation-box mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded-lg hidden">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">üìö Explanation:</h4>
                        <p class="text-gray-700 dark:text-gray-300">{{ question.explanation }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

                    <div class="mt-6 flex justify-between items-center">
                <button id="prevBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ‚Üê Previous
                </button>
                <div class="flex gap-3">
                    <button id="nextBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium hidden">
                        Next Question ‚Üí
                    </button>
                    <button id="finishBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium hidden">
                        Finish Drill ‚úì
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div id="resultsSummary" class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hidden">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">üéØ Drill Complete!</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                <div class="text-4xl font-bold text-green-600 dark:text-green-400" id="correctCount">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Correct</div>
            </div>
            <div class="text-center p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                <div class="text-4xl font-bold text-red-600 dark:text-red-400" id="wrongCount">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Wrong</div>
            </div>
            <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <div class="text-4xl font-bold text-blue-600 dark:text-blue-400" id="accuracy">0%</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Accuracy</div>
            </div>
        </div>
        <div class="mt-8 text-center flex gap-4 justify-center">
            <a href="{{ url_for('drill_mcq') }}" class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors text-lg">
                üîÑ New Set (10 Questions)
            </a>
            <button id="continueDrillBtn" class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors text-lg">
                ‚ö° Continue Drilling
            </button>
        </div>
    </div>

    {% else %}
    <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No questions available</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Check back later for new questions.</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questions = document.querySelectorAll('.question-item');
    if (questions.length === 0) return;
    
    const SESSION_KEY = 'mcq_drill_session';
    const currentQuestionSpan = document.getElementById('currentQuestion');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const finishBtn = document.getElementById('finishBtn');
    const resultsSummary = document.getElementById('resultsSummary');
    const correctDisplay = document.getElementById('correctDisplay');
    const wrongDisplay = document.getElementById('wrongDisplay');
    
    // Load saved session or start fresh
    let session = JSON.parse(localStorage.getItem(SESSION_KEY) || '{}');
    let currentQuestionIndex = session.currentIndex || 0;
    let answers = session.answers || {};
    let correctCount = session.correctCount || 0;
    let wrongCount = session.wrongCount || 0;
    
    // Restore display
    if (correctCount > 0) correctDisplay.textContent = correctCount;
    if (wrongCount > 0) wrongDisplay.textContent = wrongCount;
    
    // Save session function
    function saveSession() {
        localStorage.setItem(SESSION_KEY, JSON.stringify({
            currentIndex: currentQuestionIndex,
            answers: answers,
            correctCount: correctCount,
            wrongCount: wrongCount,
            timestamp: Date.now()
        }));
    }

    function showQuestion(index) {
        questions.forEach((q, i) => {
            q.classList.toggle('hidden', i !== index);
        });
        currentQuestionSpan.textContent = index + 1;
        
        const currentQuestion = questions[index];
        const submitBtn = currentQuestion.querySelector('.submit-btn');
        
        // Check if already answered
        const questionId = currentQuestion.dataset.questionId;
        if (answers[questionId]) {
            // Already answered, show explanation and next button
            submitBtn.classList.add('hidden');
            showFeedback(currentQuestion, answers[questionId].isCorrect, answers[questionId].correct);
            if (index < questions.length - 1) {
                nextBtn.classList.remove('hidden');
            } else {
                finishBtn.classList.remove('hidden');
            }
        } else {
            // Not answered yet
            submitBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            finishBtn.classList.add('hidden');
        }
        
        // Update prev button
        prevBtn.disabled = index === 0;
    }

    function showFeedback(questionElem, isCorrect, correctAnswer) {
        const feedbackBanner = questionElem.querySelector('.feedback-banner');
        const feedbackTitle = questionElem.querySelector('.feedback-title');
        const feedbackMessage = questionElem.querySelector('.feedback-message');
        const feedbackIcon = questionElem.querySelector('.feedback-icon');
        const explanationBox = questionElem.querySelector('.explanation-box');
        const answerOptions = questionElem.querySelectorAll('.answer-option');
        
        feedbackBanner.classList.remove('hidden');
        explanationBox.classList.remove('hidden');
        
        // Disable all radio buttons
        questionElem.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.disabled = true;
        });
        
        // Highlight correct and wrong answers
        answerOptions.forEach((option, idx) => {
            if (idx === correctAnswer) {
                option.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
                option.classList.remove('border-gray-200', 'dark:border-gray-600');
            } else {
                const radio = option.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    option.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                    option.classList.remove('border-gray-200', 'dark:border-gray-600');
                }
            }
        });
        
        if (isCorrect) {
            feedbackBanner.classList.add('bg-green-100', 'dark:bg-green-900/30', 'border-l-4', 'border-green-500');
            feedbackTitle.classList.add('text-green-800', 'dark:text-green-200');
            feedbackMessage.classList.add('text-green-700', 'dark:text-green-300');
            feedbackTitle.textContent = '‚úì Correct!';
            feedbackMessage.textContent = 'Well done! You got it right.';
            feedbackIcon.classList.add('text-green-500');
        } else {
            feedbackBanner.classList.add('bg-red-100', 'dark:bg-red-900/30', 'border-l-4', 'border-red-500');
            feedbackTitle.classList.add('text-red-800', 'dark:text-red-200');
            feedbackMessage.classList.add('text-red-700', 'dark:text-red-300');
            feedbackTitle.textContent = '‚úó Incorrect';
            feedbackMessage.textContent = 'The correct answer has been highlighted below.';
            feedbackIcon.classList.add('text-red-500');
            feedbackIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>';
        }
    }

    function updateProgressBar() {
        const answeredCount = Object.keys(answers).length;
        const progressPercent = (answeredCount / questions.length) * 100;
        const progressBar = document.getElementById('progressBar');
        const progressCount = document.getElementById('progressCount');
        
        if (progressBar) {
            progressBar.style.width = progressPercent + '%';
        }
        if (progressCount) {
            progressCount.textContent = answeredCount;
        }
    }

    function submitAnswer(questionElem) {
        const selectedAnswer = questionElem.querySelector('input[type="radio"]:checked');
        
        if (!selectedAnswer) {
            alert('Please select an answer');
            return;
        }

        const questionId = questionElem.dataset.questionId;
        const selectedIndex = parseInt(selectedAnswer.value);
        const correctAnswer = parseInt(questionElem.dataset.correctAnswer);
        
        const isCorrect = selectedIndex === correctAnswer;
        answers[questionId] = { selected: selectedIndex, correct: correctAnswer, isCorrect };
        
        if (isCorrect) {
            correctCount++;
            correctDisplay.textContent = correctCount;
        } else {
            wrongCount++;
            wrongDisplay.textContent = wrongCount;
        }

        // Update progress bar
        updateProgressBar();
        
        // Save session
        saveSession();

        // Hide submit button
        const submitBtn = questionElem.querySelector('.submit-btn');
        submitBtn.classList.add('hidden');
        
        // Show feedback
        showFeedback(questionElem, isCorrect, correctAnswer);
        
        // Show next/finish button
        if (currentQuestionIndex < questions.length - 1) {
            nextBtn.classList.remove('hidden');
        } else {
            finishBtn.classList.remove('hidden');
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
            nextBtn.classList.add('hidden');
        }
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
        }
    }

    function finishDrill() {
        // Send results to server
        Object.keys(answers).forEach(questionId => {
            const answer = answers[questionId];
            fetch('/drill/mcq/answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question_id: questionId,
                    selected_answer: answer.selected
                })
            });
        });

        // Clear session
        localStorage.removeItem(SESSION_KEY);

        // Show results
        document.getElementById('correctCount').textContent = correctCount;
        document.getElementById('wrongCount').textContent = wrongCount;
        const accuracyPercent = Math.round((correctCount / questions.length) * 100);
        document.getElementById('accuracy').textContent = accuracyPercent + '%';
        
        resultsSummary.classList.remove('hidden');
        document.getElementById('questionContainer').parentElement.style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Allow unselecting radio buttons by clicking again
    document.querySelectorAll('.answer-option').forEach(label => {
        label.addEventListener('click', function(e) {
            const radio = this.querySelector('.choice-radio');
            if (radio && !radio.disabled) {
                // If clicking the already selected radio, unselect it
                if (radio.checked && e.target !== radio) {
                    e.preventDefault();
                    radio.checked = false;
                }
            }
        });
    });
    
    // Event listeners - use event delegation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('submit-btn') || e.target.closest('.submit-btn')) {
            const btn = e.target.classList.contains('submit-btn') ? e.target : e.target.closest('.submit-btn');
            const questionElem = btn.closest('.question-item');
            submitAnswer(questionElem);
        }
    });
    
    nextBtn.addEventListener('click', nextQuestion);
    prevBtn.addEventListener('click', prevQuestion);
    finishBtn.addEventListener('click', finishDrill);
    
    // Continuous drilling mode
    document.getElementById('continueDrillBtn')?.addEventListener('click', function() {
        // Reload the page to get new questions
        window.location.href = '{{ url_for("drill_mcq") }}';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        const currentQuestion = questions[currentQuestionIndex];
        const submitBtn = currentQuestion.querySelector('.submit-btn');
        
        if (e.key >= '1' && e.key <= '4') {
            const radioButtons = currentQuestion.querySelectorAll('input[type="radio"]');
            const index = parseInt(e.key) - 1;
            if (radioButtons[index] && !radioButtons[index].disabled) {
                radioButtons[index].checked = true;
            }
        } else if (e.key === 'Enter') {
            if (!submitBtn.classList.contains('hidden')) {
                submitAnswer(currentQuestion);
            } else if (!nextBtn.classList.contains('hidden')) {
                nextQuestion();
            } else if (!finishBtn.classList.contains('hidden')) {
                finishDrill();
            }
        }
    });

    // Initialize - restore progress and show current question
    updateProgressBar();
    showQuestion(currentQuestionIndex);
});
</script>
{% endblock %}

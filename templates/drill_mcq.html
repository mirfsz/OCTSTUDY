{% extends "base.html" %}

{% block title %}MCQ Drill - SPF Study Coach{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">MCQ Drill</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Test your knowledge with quick practice questions</p>
    </div>

    {% if questions %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <span class="text-sm text-gray-500 dark:text-gray-400">
                    Question <span id="currentQuestion">1</span> of {{ questions|length }}
                </span>
                <div class="flex space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full" id="correctIndicator" style="display: none;"></div>
                    <div class="w-3 h-3 bg-red-500 rounded-full" id="wrongIndicator" style="display: none;"></div>
                </div>
            </div>

            <div id="questionContainer">
                {% for question in questions %}
                <div class="question-item {% if loop.index != 1 %}hidden{% endif %}" data-question-id="{{ question.id }}" data-correct-answer="{{ question.answer_idx }}">
                    <div class="mb-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            {{ question.topic_name }}
                        </span>
                    </div>
                    
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-6">
                        {{ question.stem }}
                    </h3>

                    <div class="space-y-3">
                        {% for choice in question.choices %}
                        <label class="flex items-center p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <input type="radio" name="answer" value="{{ loop.index0 }}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            <span class="ml-3 text-gray-900 dark:text-white">{{ choice }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <div class="mt-6">
                        <button id="submitAnswer" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            Submit Answer
                        </button>
                    </div>

                    <div id="explanation" class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hidden">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Explanation:</h4>
                        <p class="text-gray-700 dark:text-gray-300">{{ question.explanation }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="mt-6 flex justify-between">
                <button id="prevQuestion" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Previous
                </button>
                <button id="nextQuestion" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" style="display: none;">
                    Next Question
                </button>
                <button id="finishDrill" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors" style="display: none;">
                    Finish Drill
                </button>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div id="resultsSummary" class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hidden">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Drill Complete!</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="correctCount">0</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Correct</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="wrongCount">0</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Wrong</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="accuracy">0%</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Accuracy</div>
            </div>
        </div>
        <div class="mt-6 text-center">
            <a href="{{ url_for('drill_mcq') }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                Start New Drill
            </a>
        </div>
    </div>

    {% else %}
    <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No questions available</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Check back later for new questions.</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questions = document.querySelectorAll('.question-item');
    const currentQuestionSpan = document.getElementById('currentQuestion');
    const submitButton = document.getElementById('submitAnswer');
    const prevButton = document.getElementById('prevQuestion');
    const nextButton = document.getElementById('nextQuestion');
    const finishButton = document.getElementById('finishDrill');
    const resultsSummary = document.getElementById('resultsSummary');
    
    let currentQuestionIndex = 0;
    let answers = {};
    let correctCount = 0;
    let wrongCount = 0;

    function showQuestion(index) {
        questions.forEach((q, i) => {
            q.classList.toggle('hidden', i !== index);
        });
        currentQuestionSpan.textContent = index + 1;
        
        // Reset form
        const radioButtons = questions[index].querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => radio.checked = false);
        
        // Show/hide buttons
        prevButton.disabled = index === 0;
        nextButton.style.display = 'none';
        finishButton.style.display = 'none';
        submitButton.style.display = 'block';
        
        // Hide explanation
        const explanation = questions[index].querySelector('#explanation');
        explanation.classList.add('hidden');
        
        // Hide indicators
        document.getElementById('correctIndicator').style.display = 'none';
        document.getElementById('wrongIndicator').style.display = 'none';
    }

    function submitAnswer() {
        const currentQuestion = questions[currentQuestionIndex];
        const selectedAnswer = currentQuestion.querySelector('input[name="answer"]:checked');
        
        if (!selectedAnswer) {
            alert('Please select an answer');
            return;
        }

        const questionId = currentQuestion.dataset.questionId;
        const selectedIndex = parseInt(selectedAnswer.value);
        const correctAnswer = parseInt(currentQuestion.dataset.correctAnswer);
        
        const isCorrect = selectedIndex === correctAnswer;
        answers[questionId] = { selected: selectedIndex, correct: correctAnswer, isCorrect };
        
        if (isCorrect) {
            correctCount++;
            document.getElementById('correctIndicator').style.display = 'block';
        } else {
            wrongCount++;
            document.getElementById('wrongIndicator').style.display = 'block';
        }

        // Show explanation
        const explanation = currentQuestion.querySelector('#explanation');
        explanation.classList.remove('hidden');
        
        // Disable radio buttons
        const radioButtons = currentQuestion.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => radio.disabled = true);
        
        // Show next/finish button
        submitButton.style.display = 'none';
        if (currentQuestionIndex < questions.length - 1) {
            nextButton.style.display = 'inline-block';
        } else {
            finishButton.style.display = 'inline-block';
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
        }
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
        }
    }

    function finishDrill() {
        // Send results to server
        Object.keys(answers).forEach(questionId => {
            const answer = answers[questionId];
            fetch('/drill/mcq/answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question_id: questionId,
                    selected_answer: answer.selected
                })
            });
        });

        // Show results
        document.getElementById('correctCount').textContent = correctCount;
        document.getElementById('wrongCount').textContent = wrongCount;
        document.getElementById('accuracy').textContent = Math.round((correctCount / questions.length) * 100) + '%';
        
        resultsSummary.classList.remove('hidden');
        document.getElementById('questionContainer').style.display = 'none';
    }

    // Event listeners
    submitButton.addEventListener('click', submitAnswer);
    nextButton.addEventListener('click', nextQuestion);
    prevButton.addEventListener('click', prevQuestion);
    finishButton.addEventListener('click', finishDrill);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key >= '1' && e.key <= '4') {
            const currentQuestion = questions[currentQuestionIndex];
            const radioButtons = currentQuestion.querySelectorAll('input[type="radio"]');
            const index = parseInt(e.key) - 1;
            if (radioButtons[index]) {
                radioButtons[index].checked = true;
            }
        } else if (e.key === 'Enter') {
            const submitButton = document.getElementById('submitAnswer');
            if (submitButton.style.display !== 'none') {
                submitAnswer();
            } else if (nextButton.style.display !== 'none') {
                nextQuestion();
            } else if (finishButton.style.display !== 'none') {
                finishDrill();
            }
        }
    });

    // Initialize
    showQuestion(0);
});
</script>
{% endblock %}
